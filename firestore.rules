rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function hasRole(role) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    function belongsToOrg(orgId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
    }
    
    function isOrgAdmin(orgId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/organizations/$(orgId)) &&
             get(/databases/$(database)/documents/organizations/$(orgId)).data.adminId == request.auth.uid;
    }

    // Users collection
    match /users/{userId} {
      // Users can read and write their own document
      allow read, write: if isOwner(userId);
      // Admins can read users in their organization
      allow read: if hasRole('admin') && 
                     exists(/databases/$(database)/documents/users/$(userId)) &&
                     get(/databases/$(database)/documents/users/$(userId)).data.organizationId == 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId;
    }

    // Organizations collection
    match /organizations/{orgId} {
      // Organization admin can read and write their organization
      allow read, write: if isOrgAdmin(orgId);
      // Organization members can read their organization
      allow read: if belongsToOrg(orgId);
      // Authenticated users can create organizations (for admin setup)
      allow create: if isAuthenticated() && hasRole('admin');
    }

    // Campaigns collection
    match /campaigns/{campaignId} {
      // Campaign creator (admin) can read, write, delete
      allow read, write, delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
      // Organization members can read campaigns in their org
      allow read: if isAuthenticated() && belongsToOrg(resource.data.orgId);
      // Admins can create campaigns for their organization
      allow create: if hasRole('admin') && 
                       request.resource.data.orgId == 
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId;
      // Organization members can update participants array (to join campaigns)
      allow update: if isAuthenticated() && 
                       belongsToOrg(resource.data.orgId) &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['participants', 'updatedAt']);
    }

    // Achievements collection
    match /achievements/{achievementId} {
      // Users can create achievements for themselves
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Users can read their own achievements
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Admins can read and verify achievements in their organization campaigns
      allow read, update: if hasRole('admin') && 
                             exists(/databases/$(database)/documents/campaigns/$(resource.data.campaignId)) &&
                             belongsToOrg(get(/databases/$(database)/documents/campaigns/$(resource.data.campaignId)).data.orgId);
      // Organization members can read achievements in their org campaigns
      allow read: if isAuthenticated() && 
                     exists(/databases/$(database)/documents/campaigns/$(resource.data.campaignId)) &&
                     belongsToOrg(get(/databases/$(database)/documents/campaigns/$(resource.data.campaignId)).data.orgId);
    }

    // Analytics collection (if we store analytics data)
    match /analytics/{document} {
      // Only admins can access analytics
      allow read, write: if hasRole('admin');
    }
  }
}